L.Sim=L.Playback.extend({options:{displayObjectCallback:function(a){}},initialize:function(a,b,c,d){L.Playback.prototype.initialize.call(this,a,b,c,d)},_callbacks:function(a){for(var b=this._callbacksArry,c=0,d=b.length;c<d;c++)b[c](a,this)}}),L.Sim.selectedPin=!1,L.Sim.getTypeInfo=function(a,b){var c;return a&&a.objectTypes&&(a.objectTypes.hasOwnProperty(b)?(c=a.objectTypes[b],c.name=b):a.objectTypes.hasOwnProperty("default")&&(c=a.objectTypes.default,c.name="default")),c||(c=L.Sim.Theme.defaultTypeInfo),c},L.Sim.displayObjectDetails=function(a){console.log("display >> ",a),L.Sim.selectedPin&&L.Sim.selectedPin.off("move"),L.Sim.selectedPin=a,a.hasEventListeners("move")||a.on("move",function(a){L.Sim.displayObjectDetails(a.target)}),L.Sim.Theme.displayObjectDetails&&L.Sim.Theme.displayObjectDetails(a)},L.Playback.MoveableMarker.prototype._old_initialize=L.Playback.MoveableMarker.prototype.initialize,L.Playback.MoveableMarker=L.Playback.MoveableMarker.extend({initialize:function(a,b,c){this.location=a;var d=b.marker||{};jQuery.isFunction(d)&&(d=d(c)),L.Marker.prototype.initialize.call(this,a,d),this.popupContent="",this.feature=c,d.getPopup&&(this.popupContent=d.getPopup(c)),b.popups&&this.bindPopup(this.getPopupContent()+a.toString()),b.labels&&(this.bindLabel?this.bindLabel(this.getPopupContent()):console.log("Label binding requires leaflet-label (https://github.com/Leaflet/Leaflet.label)"))},setProperties:function(a){if(this.agentProperties=this.agentProperties||{},this.agentProperties!=a&&!jQuery.isEmptyObject(a)){var b=this._data.typeInfo,c=jQuery.extend({},b.options),d=0;for(var e in a)if(a.hasOwnProperty(e)&&a[e]!=this.agentProperties[e]&&(this.agentProperties[e]=a[e],b&&b.status&&b.status.hasOwnProperty(e))){var f=b.status[e].values.indexOf(a[e]);for(var g in b.status[e].valueOptions[f])c[g]=b.status[e].valueOptions[f][g],d++}d>0&&this.setIcon(L.Sim.icon(c,b))}}}),L.Playback.Track.prototype._old_initialize=L.Playback.Track.prototype.initialize,L.Playback.Track.prototype._old_moveMarker=L.Playback.Track.prototype.moveMarker,L.Playback.Track=L.Playback.Track.extend({initialize:function(a,b){this._old_initialize(a,b),this.propertyTicks={};var c=this._geoJSON.properties.changes;if(c.length>0&&c.length!=this._geoJSON.properties.time.length)console.error("Time samples have different length than property changes!");else for(var d=0;d<c.length;d++)this.propertyTicks[this._geoJSON.properties.time[d]]=c[d]},moveMarker:function(a,b,c){this._marker&&(this._marker.setProperties(this.getPropertyChange(c)),this._old_moveMarker(a,b,c))},getPropertyChange:function(a){return this.propertyTicks.hasOwnProperty(a)?this.propertyTicks[a]:{}}}),L.Playback.TrackController.prototype._old_initialize=L.Playback.TrackController.prototype.initialize,L.Playback.TrackController=L.Playback.TrackController.extend({initialize:function(a,b,c){this._old_initialize(a,b,c)},_prepareClusters:function(){if(!this._markersClusters){this._markersClusters={};for(var a in this.options.objectTypes)this._markersClusters[a]=L.Sim.markerClusterGroup({typeInfo:this.getTypeInfo(a)}),this._map.addLayer(this._markersClusters[a])}},addTrack:function(a,b){if(a){var c=a.setMarker(b,this.options);c=this.getMarkerIcon(c,a),c&&(this.options.enableClusters?(this._prepareClusters(),this._markersClusters[c.type].addLayer(c),markerCluster=this._markersClusters):c.addTo(this._map),this._tracks.push(a))}},getTypeInfo:function(a){return L.Sim.getTypeInfo(this.options,a)},getMarkerIcon:function(a,b){if(b){var c={title:b._geoJSON.title,groupIds:b._geoJSON.groupIds,type:b._geoJSON.visualType};a.title=c.title,a.groupIds=c.groupIds,a.type=c.type;var d=this.getTypeInfo(c.type);return c.typeInfo=d,a.typeInfo=d,a.type=d.name,a.options.icon=L.Sim.icon(d.options,d),a._data=c,a.on("click",function(){L.Sim.displayObjectDetails(this)}),a}},handleEvents:function(a){this.options.events=this.options.events||{},this._eventMarkers=this._eventMarkers||[];var a=a/1e3;if(a%1==0){for(var b=this.options.events[a]||[],c=0;c<this._eventMarkers.length;c++)this._map.removeLayer(this._eventMarkers[c]);this._eventMarkers=[];for(var d=0;d<b.length;d++){var e=new L.Sim.Event(this,b[d]);e.addToLog(),e.hasLocation()&&this._eventMarkers.push(e.addToMap())}}},tock:function(a,b){var c={};this._markersCluster=this._markersCluster||{};for(var d in this._markersClusters)c[d]=this._markersClusters[d].getLayers(),this._markersClusters[d].clearLayers();this.handleEvents(a);for(var e=0,f=this._tracks.length;e<f;e++){var g=this._tracks[e].tick(a),h=new L.LatLng(g[1],g[0]);this._tracks[e].moveMarker(h,b,a)}for(var d in this._markersClusters)this._markersClusters[d].addLayers(c[d])}}),L.Sim.Icon=L.DivIcon.extend({initialize:function(a,b){a=L.Util.setOptions(this,a),this.typeInfo=b},setCluster:function(a){this.cluster=a},getClusterLabel:function(){var a=document.createElement("div"),b=this.cluster.getChildCount(),c=" sim-marker-label-";return c+=b<10?"green":b<100?"orange":"red",a.innerHTML="<div><span>"+b+"</span></div>",a.className="sim-marker-label "+c,a},createIcon:function(a){var b,c=this.typeInfo,d=this.options;if(b="rectangle"==c.type?this.createRectangleIcon(d):"circle"==c.type?this.createCircleIcon(d):"image"==c.type?this.createImageIcon(d):this.createAwesomeIcon(d),d.bgPos){var e=L.point(d.bgPos);b.style.backgroundPosition=-e.x+"px "+-e.y+"px"}return this._setIconStyles(b,"icon"),this.cluster&&b.appendChild(this.getClusterLabel()),b},_setDivIconStyles:function(a){for(var b in this.options)a.style[b]=this.options[b]},createAwesomeIcon:function(a){var b=$.extend({},a);b.iconSize=[35,45],b.className="awesome-marker",b.prefix="fa";var c=L.AwesomeMarkers.icon(b);return a.iconSize=[35,45],a.className="awesome-marker",a.className+=" awesome-marker-icon-"+(b.markerColor||"blue"),c.createIcon()},createCircleIcon:function(a){var b=document.createElement("div");b.className="sim-marker sim-marker-circle",a.className="sim-marker sim-marker-circle";var c=parseInt(a.radius||10);return b.style.width=2*c+"px",b.style.height=2*c+"px",a.iconSize=[2*c,2*c],b},createImageIcon:function(a){var b=document.createElement("div"),a=this.options,c=parseInt(a.width||20),d=parseInt(a.height||20);return b.className="sim-marker sim-marker-image",a.className="sim-marker sim-marker-image",b.innerHTML='<img src="'+(a.iconUrl||L.Sim.Theme.defaultIconUrl)+'" alt="">',a.iconSize=[c,d],b},createRectangleIcon:function(a){var b=document.createElement("div");b.className="sim-marker sim-marker-rectangle",a.className="sim-marker sim-marker-rectangle";var c=parseInt(a.width||20),d=parseInt(a.height||20);return b.style.width=c+"px",b.style.height=d+"px",a.iconSize=[c,d],b}}),L.Sim.icon=function(a,b){return new L.Sim.Icon(a,b)},L.Sim.MarkerClusterGroup=L.MarkerClusterGroup.extend({_defaultIconCreateFunction:function(a){var b=this.typeInfo.options||{},c=L.Sim.icon(b,this.typeInfo);return c.setCluster(a),c}}),L.Sim.markerClusterGroup=function(a){return new L.Sim.MarkerClusterGroup(a)},L.Sim.Event=L.Class.extend({initialize:function(a,b){this.context=a,this.type=b.type,this.location=b.location},getTypeInfo:function(){return this.context.options.eventTypes.hasOwnProperty(this.type)?this.context.options.eventTypes[this.type]:(console.log("EventType ",this.type," does not exist in ",this.context.options.eventTypes),{})},addToLog:function(){L.Sim.Theme.addEventToLog&&L.Sim.Theme.addEventToLog(this.getTypeInfo(),this.location)},hasLocation:function(){return this.location&&2==this.location.length},addToMap:function(){var a=this.getTypeInfo();console.log("Adding Event to map with typeInfo: ",a);var b=new L.marker(this.location,{icon:L.Sim.icon(a.options,a)});return b.addTo(this.context._map),b}}),L.Sim.Theme={defaultTypeInfo:{type:"circle",name:"default",radius:10,options:{fillColor:"#ff0000"}},defaultIconUrl:"/static/assets/images/drone.png",displayObjectDetails:function(a){console.log("L.Sim.Theme: displayObjectDetails is not set.")},addEventToLog:function(a,b){console.log("L.Sim.Theme: addEventToLog is not set.")}};